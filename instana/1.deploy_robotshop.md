# Robotshop deployment in a Linux virtual machine

In this tutorial we will be configuring an application using docker in a linux virtual machine

We define the following scenario
- We have a linux virtual machine (in our case a RHEL 8)
- We already have a INSTANA tenant

Configure the virtual machine
=

1. Connect the virtual machine using ssh. In our example we have a SSH KEY

       ssh -i pem_ibmcloudvsi_download.pem 169.55.98.38 -p 2223 -l itzuser
   
3. Install the yum-utils package (which provides the yum-config-manager utility) and set up the repository

        sudo yum install -y yum-utils
        sudo yum-config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo

   
4. Install Docker Engine, containerd, and Docker Compose:

        sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
   
5. Start docker

        sudo systemctl start docker

6. test docker

       sudo docker run hello-world

7. Deploy git in the virtual machine

       sudo yum install git

8. Clone the repository to the virtual machine

       git clone https://github.com/instana/robot-shop.git

Deploy the Robot Shop application
=

1. Pull and Deploy the application

       sudo docker compose pull

2. Run the application

       sudo docker compose up   

3. Open another ssh to the virtual machine and give load to the application using the following

       sudo docker compose -f docker-compose.yaml -f docker-compose-load.yaml up

4. Use a load generator

          cd load-gen
          ./build.sh
          ./load-gen.sh

Deploy the Instana Agent in the virtual machine
=

1. Then open Instana, go to Settings -> Agents. Then select Install Agents button and finally select the Linux Automatic Installation (One liner)

2. From Step 1 use the defaults (Dynamic, Azul Zulu 1.8 and Interactive) and in the Step 2 select "Install and start as service". Copy the line and execute in the virtual machine
    
3. You could check the status of the agent in the virtual machine and using the Instana UI

       sudo systemctl status instana-agent.service
       
4. Using the Instana UI, you could go to Settings -> Agents and review the Agent Details (you could see the icon with the magnifying glass to select your virtual machine)


Change the behaviour of the application
=

1. If you want to add more load to the application and introduce an error in Payment you could modify the load-gen.sh file from the folder loadgen. You need to do the following changes, at least

       - NUM_CLIENTS=100                                    ---- this is line 7
       - RUNTIME=1h                                         ---- this is line 10
       - ERROR=1                                            ---- this is line 16
       - name loadgen2                                      ---- this is line 97
   
2. Then you could run the loader using the following command

     sudo ./load-gen.sh 


Create a Zone for the Virtual Machine
=

1. If you want to put your virtual machine in a particular zone, we could edit the file configuration.yaml in /opt/instana/agent/etc/instana and modify the file to have something like the following

       # Hardware & Zone
       com.instana.plugin.generic.hardware:
         enabled: true # disabled by default
         availability-zone: 'Demo'

 2. Saving the file, we need to wait a couple of minutes and the Infrastructure dashboard will show the VM in a zone called DEMO



Optional. Deploy Quote of the day application
=

https://gitlab.com/quote-of-the-day/quote-of-the-day/-/tree/master


Troubleshooting the App
=

If the application dont show connections between the components, restart docker service and start again the application

       systemctl stop docker
       systemctl stop docker.service
       systemctl start docker
       sudo docker compose up 

in another terminal

       cd load-gen
       ./load-gen.sh
 


# Information used to create this How-to

1. https://github.com/instana/robot-shop/tree/master
2. https://docs.docker.com/engine/install/rhel        

