# Crear y Usar una API Simple con MySQL y Java desde una P√°gina Web en Apache (2 M√°quinas Virtuales)

Este documento describe paso a paso c√≥mo configurar dos m√°quinas virtuales en RHEL para una arquitectura distribuida:

* **M√°quina 1 (Front-end):** Apache sirve p√°gina web en el puerto 8080.
* **M√°quina 2 (Back-end):** API REST en Java (Spring Boot) escucha en el puerto 8080 y consulta MySQL.

---

## üñ•Ô∏è Arquitectura General

```
[Usuario] ‚Üí [VM1: Apache (puerto 8080)] ‚Üí [VM2: API Java (Spring Boot) (puerto 8080)] ‚Üí [MySQL local en VM2]
```

---

## üîß VM2: API REST en Java y MySQL

### 1. Requisitos Previos

```bash
sudo dnf install java-17-openjdk maven mariadb-server -y
sudo systemctl enable --now mariadb
```

Verificar:

```bash
java -version
mvn -version
```

### 2. Configurar MySQL

```bash
mysql_secure_installation
mysql -u root -p
```

```sql
CREATE DATABASE clientes_db;
USE clientes_db;
CREATE TABLE clientes (
  IdCliente INT PRIMARY KEY,
  Nombre VARCHAR(100),
  Direccion VARCHAR(255),
  Correo VARCHAR(100)
);
INSERT INTO clientes VALUES
  (1, 'Juan P√©rez', 'Calle Falsa 123', 'juan@example.com'),
  (2, 'Mar√≠a G√≥mez', 'Av. Siempre Viva 456', 'maria@example.com');
```

### 3. Crear API con Spring Boot

#### a) Estructura del proyecto

1. Crea un directorio base para tu API, por ejemplo `/opt/mi-api`:

   ```bash
   sudo mkdir -p /opt/mi-api
   sudo chown $USER:$USER /opt/mi-api
   cd /opt/mi-api
   ```
2. Genera un proyecto Maven usando Spring Initializr o ejecuta:

   ```bash
   mvn archetype:generate \
     -DgroupId=com.miempresa.clientes \
     -DartifactId=mi-api \
     -DarchetypeArtifactId=maven-archetype-quickstart \
     -DinteractiveMode=false
   cd mi-api
   ```
3. La estructura resultante debe ser:

   ```
   mi-api/
   ‚îú‚îÄ‚îÄ pom.xml
   ‚îî‚îÄ‚îÄ src/
       ‚îú‚îÄ‚îÄ main/
       ‚îÇ   ‚îú‚îÄ‚îÄ java/com/miempresa/clientes/  (c√≥digo fuente)
       ‚îÇ   ‚îî‚îÄ‚îÄ resources/                    (configuraci√≥n)
       ‚îî‚îÄ‚îÄ test/
   ```

#### b) `pom.xml` (dependencias)

*Abrir y reemplazar la secci√≥n `<dependencies>` con las siguientes:*

```xml
<dependencies>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
  </dependency>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
  </dependency>
  <dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <scope>runtime</scope>
  </dependency>
</dependencies>
```

#### c) Archivos fuente y configuraci√≥n

1. **Colocar `application.properties`** en `src/main/resources/`:

   ```properties
   server.port=8080
   spring.datasource.url=jdbc:mysql://localhost:3306/clientes_db
   spring.datasource.username=root
   spring.datasource.password=
   spring.jpa.hibernate.ddl-auto=none
   ```

2. **C√≥digo Java**:

   * En `src/main/java/com/miempresa/clientes/Cliente.java`:

     ```java
     package com.miempresa.clientes;

     import javax.persistence.Entity;
     import javax.persistence.Id;

     @Entity
     public class Cliente {
       @Id
       private Integer idCliente;
       private String nombre;
       private String direccion;
       private String correo;
       // getters y setters...
     }
     ```

   * En `src/main/java/com/miempresa/clientes/ClienteRepository.java`:

     ```java
     package com.miempresa.clientes;

     import org.springframework.data.jpa.repository.JpaRepository;
     import org.springframework.stereotype.Repository;

     @Repository
     public interface ClienteRepository extends JpaRepository<Cliente, Integer> {}
     ```

   * En `src/main/java/com/miempresa/clientes/ClienteController.java`:

     ```java
     package com.miempresa.clientes;

     import org.springframework.beans.factory.annotation.Autowired;
     import org.springframework.http.ResponseEntity;
     import org.springframework.web.bind.annotation.GetMapping;
     import org.springframework.web.bind.annotation.PathVariable;
     import org.springframework.web.bind.annotation.RequestMapping;
     import org.springframework.web.bind.annotation.RestController;

     @RestController
     @RequestMapping("/api/clientes")
     public class ClienteController {

       @Autowired
       private ClienteRepository repo;

       @GetMapping("/{id}")
       public ResponseEntity<?> getCliente(@PathVariable Integer id) {
         return repo.findById(id)
             .map(ResponseEntity::ok)
             .orElse(ResponseEntity.status(404).body("Cliente no encontrado"));
       }
     }
     ```

#### d) Compilar y ejecutar

Desde la ra√≠z del proyecto (`/opt/mi-api/mi-api` si usaste el archetype):

```bash
mvn clean package
java -jar target/mi-api-0.0.1-SNAPSHOT.jar
```

Verificar que el servicio est√© escuchando en el puerto 8080:

```bash
ss -tuln | grep 8080
```

```bash
mvn clean package
java -jar target/mi-api-0.0.1-SNAPSHOT.jar
```

Verificar puerto:

```bash
ss -tuln | grep 8080
```

---

## üåê VM1: Servidor Web Apache (Front-end)

### 1. Instalar Apache

```bash
sudo dnf install httpd -y
sudo systemctl enable --now httpd
```

### 2. Configurar Apache para puerto 8080

```bash
sudo sed -i 's/Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf
sudo systemctl restart httpd
sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload
```

### 3. P√°gina HTML con JavaScript

Guardar en `/var/www/html/index.html`:

```html
<!DOCTYPE html>
<html>
<head>
  <title>Buscar Cliente</title>
  <script>
    async function buscarCliente() {
      const id = document.getElementById('idCliente').value;
      const res = await fetch('http://<IP_VM2>:8080/api/clientes/' + id);
      const data = await res.json();
      document.getElementById('resultado').innerHTML = data.idCliente ?
        `Nombre: ${data.nombre}<br>Direcci√≥n: ${data.direccion}<br>Correo: ${data.correo}` :
        data;
    }
  </script>
</head>
<body>
  <h1>Consulta de Cliente</h1>
  <input type="number" id="idCliente" placeholder="ID cliente">
  <button onclick="buscarCliente()">Buscar</button>
  <div id="resultado"></div>
</body>
</html>
```

---

## üîÑ Flujo de Funcionamiento

1. Usuario navega a `http://<IP_VM1>:8080/index.html`.
2. Ingresa ID de cliente.
3. Front-end (VM1) hace `fetch` a `http://<IP_VM2>:8080/api/clientes/{id}`.
4. API Java (VM2) consulta MySQL y devuelve JSON.
5. Front-end muestra los datos.

---

## ‚úÖ Resultado Final

Separaci√≥n de responsabilidades:

* **VM1:** Sirve interfaz (puerto 8080).
* **VM2:** L√≥gica de negocio y datos (puerto 8080 + MySQL).

Perfecto para entender despliegue distribuido, balanceo y escalabilidad.

---

## üìù Scripts de Configuraci√≥n

Para facilitar la r√©plica del entorno, puedes usar estos scripts:

### Script para VM1 (Front-end): `setup_vm1.sh`

```bash
#!/bin/bash

# Instalar y habilitar Apache
dnf install httpd -y
systemctl enable --now httpd

# Configurar Apache para escuchar en el puerto 8080
sed -i 's/Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf
systemctl restart httpd

# Abrir el puerto en el firewall
firewall-cmd --add-port=8080/tcp --permanent
firewall-cmd --reload

# Crear p√°gina de consulta de cliente
tmpfile=$(mktemp)
cat << 'EOF' > $tmpfile
<!DOCTYPE html>
<html>
<head>
  <title>Buscar Cliente</title>
  <script>
    async function buscarCliente() {
      const id = document.getElementById('idCliente').value;
      const res = await fetch('http://<IP_VM2>:8080/api/clientes/' + id);
      const data = await res.json();
      document.getElementById('resultado').innerHTML = data.idCliente ?
        `Nombre: ${data.nombre}<br>Direcci√≥n: ${data.direccion}<br>Correo: ${data.correo}` :
        data;
    }
  </script>
</head>
<body>
  <h1>Consulta de Cliente</h1>
  <input type="number" id="idCliente" placeholder="ID cliente">
  <button onclick="buscarCliente()">Buscar</button>
  <div id="resultado"></div>
</body>
</html>
EOF
mv $tmpfile /var/www/html/index.html
chown apache:apache /var/www/html/index.html
```

### Script para VM2 (Back-end): `setup_vm2.sh`

```bash
#!/bin/bash

# Instalar Java, Maven y MySQL
dnf install java-17-openjdk maven mariadb-server -y
systemctl enable --now mariadb

# Configurar MySQL
echo "ALTER USER 'root'@'localhost' IDENTIFIED BY '';" | mysql
mysql -u root -e "CREATE DATABASE IF NOT EXISTS clientes_db;"
mysql -u root -D clientes_db << 'SQL'
CREATE TABLE IF NOT EXISTS clientes (
  IdCliente INT PRIMARY KEY,
  Nombre VARCHAR(100),
  Direccion VARCHAR(255),
  Correo VARCHAR(100)
);
INSERT INTO clientes (IdCliente, Nombre, Direccion, Correo) VALUES
  (1,'Juan P√©rez','Calle Falsa 123','juan@example.com'),
  (2,'Mar√≠a G√≥mez','Av. Siempre Viva 456','maria@example.com')
ON DUPLICATE KEY UPDATE Nombre=VALUES(Nombre);
SQL

# Asumimos que el repositorio de la API est√° en /opt/mi-api
cd /opt/mi-api || exit 1

# Configurar application.properties
cat << 'EOF' > src/main/resources/application.properties
server.port=8080
spring.datasource.url=jdbc:mysql://localhost:3306/clientes_db
spring.datasource.username=root
spring.datasource.password=
spring.jpa.hibernate.ddl-auto=none
EOF

# Compilar y ejecutar la API
echo "Construyendo la aplicaci√≥n..."
mvn clean package -DskipTests
nohup java -jar target/*.jar &
```
