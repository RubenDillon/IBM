Integrando una API SOAP (opcional)
=

Durante este apartado vamos a estar incorporando una API basada en SOAP.

Suponemos la siguiente sitacion
  - Se posee una aplicacion legacy a la cual nos podemos conectar ya que expone su informacion bajo SOAP
  - Queremos construir una aplicacion moderna y que la conexion a la API no sea SOAP
  - La aplicacion va a comunicarse contra APIC usando una API Rest y APIC va a convertir esa llamada a SOAP

Para lograr esto, lo primero que vamos a hacer es construir una pequeña aplicacion para poder probar como funciona SOAP. 

Una vez que ello funcione, lo que vamos a hacer es que APIC transforme la llamada y pueda "escuchar" API REST y luego APIC se comunique con nuestra API como lo hacia, utilizando SOAP.

En este caso, la arquitectura que tenemos es la siguiente

Frontend
  - direccion publica: 52.116.143.89
  - direccion privada: 10.240.1.172

API Server
  - direccion publica: 169.59.188.74
  - direccion privada: 10.241.64.97

Backend
  - direccion privada: 10.241.64.98


IMPORTANTE: 
-
Actualmente tenemos la aplicacion Busca Cliente, como esta indicada en el primer paso del Workshop de APIC. La aplicacion aun no esta integrada con APIC y buscamos que todos los pasos aqui detallados, sean independientes de los pasos 2 al 12 del Workshop.

Para poder avanzar, los tres servidores deben estar configurados tal como se detalla en el primer paso del Workshop.


Construir la Base de datos 
--


```
USE clientes_db;

CREATE TABLE historial_clientes (
  IdCliente INT,
  fecha DATE,
  accion VARCHAR(100)
);

INSERT INTO historial_clientes VALUES
(1, '2024-01-10', 'Actualización de dirección'),
(1, '2024-03-15', 'Cambio de nombre'),
(2, '2024-02-01', 'Registro nuevo');
```

Construir la API SOAP
--

En el servidor de APIs, crear el archivo /var/www/html/api/soap_historial.php con el siguiente codigo

```
<?php
// soap_historial.php

ini_set("soap.wsdl_cache_enabled", "0");
header("Content-Type: text/xml; charset=utf-8");

// Clase con la lógica del servicio
class HistorialClientesService {
    public function getHistorialPorId() {
        $mysqli = new mysqli("10.241.64.98", "apiuser", "apipass", "clientes_db", 8080);
        $mysqli->set_charset("utf8mb4");

        if ($mysqli->connect_error) {
            throw new SoapFault("Server", "No se pudo conectar a la base de datos");
        }

        $stmt = $mysqli->prepare("SELECT fecha, accion FROM historial_clientes");

        $stmt->execute();
        $result = $stmt->get_result();

        $historial = [];
        while ($row = $result->fetch_assoc()) {
            $historial[] = $row;
        }

        $stmt->close();
        $mysqli->close();

        return $historial;
    }
}

// Opciones del servidor SOAP
$server = new SoapServer(null, [
    'uri' => "http://{$_SERVER['HTTP_HOST']}{$_SERVER['PHP_SELF']}"
]);

$server->setClass("HistorialClientesService");
$server->handle();
?>

```

Instalar SOAP en la VM

```
sudo dnf install -y php-soap
sudo systemctl restart httpd
```


Construimos el cliente que llama a la API SOAP en PHP
--

En el Frontend creamos un archivo /var/www/html/test_soap_client.php

```
<?php
$client = new SoapClient(null, [
    'location' => 'http://169.59.188.74:8080/api/soap_historial.php',
    'uri' => 'http://169.59.188.74:8080/api/soap_historial.php',
    'trace' => 1
]);

try {
    $id = 1;
    $result = $client->getHistorialPorId();
    echo "<h2>Historial de todos los clientes </h2><ul>";
    foreach ($result as $item) {
        echo "<li>{$item['fecha']}: {$item['accion']}</li>";
    }
    echo "</ul>";
} catch (SoapFault $e) {
    echo "Error: " . $e->getMessage();
}
?>



```

Para poder ejecutar, hay que instalar PHP (si aun no lo hemos hecho)

```
dnf install -y php php-soap
systemctl restart httpd

```

Testear la API SOAP desde el navegador
--

```
http://52.116.143.89:8080/test_soap_client.php
```

Deberiamos tener un resultado como el que sigue


<img width="661" height="237" alt="image" src="https://github.com/user-attachments/assets/f46e29d0-f911-4de0-ad9f-2266d3f025d3" />



Crear archivo WSDL
=

El proximo paso es crear un archivo WSDL, que es usado para describir la API SOAP

Ese archivo debemos colocarlo en /var/www/html/api/historial.wsdl donde esta la API.



```
<?xml version="1.0" encoding="UTF-8"?>
<definitions
    name="HistorialClientesService"
    targetNamespace="http://example.com/historial"
    xmlns:tns="http://example.com/historial"
    xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
    xmlns="http://schemas.xmlsoap.org/wsdl/">

  <types>
    <xsd:schema targetNamespace="http://example.com/historial">
      <xsd:complexType name="HistorialEntry">
        <xsd:sequence>
          <xsd:element name="fecha" type="xsd:string"/>
          <xsd:element name="accion" type="xsd:string"/>
        </xsd:sequence>
      </xsd:complexType>

      <xsd:complexType name="HistorialList">
        <xsd:sequence>
          <xsd:element name="item" type="tns:HistorialEntry" minOccurs="0" maxOccurs="unbounded"/>
        </xsd:sequence>
      </xsd:complexType>
    </xsd:schema>
  </types>

  <message name="getHistorialPorIdRequest"/>
  <message name="getHistorialPorIdResponse">
    <part name="return" type="tns:HistorialList"/>
  </message>

  <portType name="HistorialClientesPortType">
    <operation name="getHistorialPorId">
      <input message="tns:getHistorialPorIdRequest"/>
      <output message="tns:getHistorialPorIdResponse"/>
    </operation>
  </portType>

  <binding name="HistorialClientesBinding" type="tns:HistorialClientesPortType">
    <soap:binding style="rpc" transport="http://schemas.xmlsoap.org/soap/http"/>
    <operation name="getHistorialPorId">
      <soap:operation soapAction="getHistorialPorId"/>
      <input>
        <soap:body use="encoded" namespace="http://example.com/historial" encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"/>
      </input>
      <output>
        <soap:body use="encoded" namespace="http://example.com/historial" encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"/>
      </output>
    </operation>
  </binding>

  <service name="HistorialClientesService">
    <port name="HistorialClientesPort" binding="tns:HistorialClientesBinding">
      <soap:address location="http://169.59.188.74:8080/api/soap_historial.php"/>
    </port>
  </service>
</definitions>

```

Debemos modificar el API (soap_historial.php), para que use el WSDL

```
<?php
// soap_historial.php con WSDL

ini_set("soap.wsdl_cache_enabled", "0");;

class HistorialClientesService {
    public function getHistorialPorId() {
        $mysqli = new mysqli("10.241.64.98", "apiuser", "apipass", "clientes_db", 8080);
        $mysqli->set_charset("utf8mb4");

        if ($mysqli->connect_error) {
            throw new SoapFault("Server", "No se pudo conectar a la base de datos");
        }

        $stmt = $mysqli->prepare("SELECT fecha, accion FROM historial_clientes");
        $stmt->execute();
        $result = $stmt->get_result();

        $historial = [];
        while ($row = $result->fetch_assoc()) {
            $historial[] = $row;
        }

        $stmt->close();
        $mysqli->close();

        return ["item" => $historial];
    }
}

$server = new SoapServer("http://169.59.188.74:8080/api/historial.wsdl");
$server->setClass("HistorialClientesService");

file_put_contents("/tmp/soap_log.txt", "Se invocó SOAP desde " . $_SERVER['REMOTE_ADDR'] . "\n", FILE_APPEND);


$server->handle();

```

Verificamos que el WSDL es accesible

```
curl http://169.59.188.74:8080/api/soap_historial.wsdl
```

Modificamos el cliente para validar la API SOAP

```
<?php
$client = new SoapClient("http://169.59.188.74:8080/api/historial.wsdl", [
    'trace' => 1
]);

try {
    $response = $client->getHistorialPorId();
    echo "<h2>Historial completo:</h2><ul>";
    foreach ($response->item as $row) {
        echo "<li>{$row->fecha}: {$row->accion}</li>";
    }
    echo "</ul>";
} catch (SoapFault $e) {
    echo "Error SOAP: " . $e->getMessage();
}
?>
```

Con todos estos cambios, el resultado no debe variar.

<img width="661" height="237" alt="image" src="https://github.com/user-attachments/assets/77fc88cb-7ffb-4ac3-b229-e969de5df34d" />


Introduccion de APIC en la solucion
=

La idea de introducir APIC en esta aplicacion, es que nos permite que la aplicacion "hable" API REST contra APIC y APIC hablara SOAP contra la API.

Para ello, vamos a crear un API REST proxy based upon a WSDL (o también llamado "SOAP-to-REST proxy")

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/44027df1-d9c1-4872-bfdf-ba4ac975001c" />

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/7604976f-75a5-43e0-9129-d2cd0281e66f" />

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/7a046c21-eff3-43af-9359-7c944e8c90d4" />

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/9ffd15a4-2a92-4d38-98ac-c0222d33534c" />

Por ahora, no securizamos 
<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/0fac60e8-8fdf-40cd-8e67-8f9ab5269991" />

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/a37a1f50-6b2e-4bdd-adfd-ab48cca78d80" />

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/2568927c-9c4b-44a2-8acc-67d4e85f96fe" />

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/8dd98c65-c5d0-4fba-bf7c-e87bb14f90e0" />

<img width="1710" height="832" alt="image" src="https://github.com/user-attachments/assets/b4024366-7507-41ef-99f1-eaa1beb4de7c" />


Configuramos Vault para poder conectarnos usando https
=


Generacion del html

```
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial Clientes</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #resultado { margin-top: 10px; color: #333; }
    #resultado.error { color: red; }
  </style>
</head>
<body>
  <h1>Historial de Clientes</h1>
  <button id="buscarBtn">Mostrar historial completo</button>
  <div id="resultado"></div>

  <script>
    document.getElementById('buscarBtn').addEventListener('click', async () => {
      const out = document.getElementById('resultado');
      out.textContent = 'Cargando historial...';
      out.classList.remove('error');

      try {
        const response = await fetch('https://api.us-east-a.apiconnect.ibmappdomain.cloud/api-connect-dn-1/sandbox/historialclientesservice/getHistorialPorId', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-IBM-Client-Id': 'edad4151a9477b0d1751d6246d23bc81'
          },
          body: JSON.stringify({})  // como decidimos, sin IDCliente
        });

        if (!response.ok) {
          throw new Error(`Error en la respuesta: ${response.statusText}`);
        }

        const data = await response.json();
        if (data.return && data.return.item && data.return.item.length > 0) {
          let html = '<ul>';
          data.return.item.forEach(item => {
            html += `<li>${item.fecha.$}: ${item.accion.$}</li>`;
          });
          html += '</ul>';
          out.innerHTML = html;
        } else {
          out.textContent = 'No se encontraron registros.';
        }
      } catch (error) {
        out.textContent = `Error: ${error.message}`;
        out.classList.add('error');
      }
    });
  </script>
</body>
</html>

```


