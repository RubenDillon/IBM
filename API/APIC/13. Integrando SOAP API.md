Integrando una API SOAP (opcional)
=

Durante este apartado vamos a estar incorporando una API basada en SOAP.

Suponemos la siguiente sitacion
  - Se posee una aplicacion legacy a la cual nos podemos conectar ya que expone su informacion bajo SOAP
  - Queremos construir una aplicacion moderna y que la conexion a la API no sea SOAP
  - La aplicacion va a comunicarse contra APIC usando una API Rest y APIC va a convertir esa llamada a SOAP

Para lograr esto, lo primero que vamos a hacer es construir una peque침a aplicacion para poder probar como funciona SOAP. 

Una vez que ello funcione, lo que vamos a hacer es que APIC transforme la llamada y pueda "escuchar" API REST y luego APIC se comunique con nuestra API como lo hacia, utilizando SOAP.

En este caso, la arquitectura que tenemos es la siguiente

Frontend
  - direccion publica: 52.116.143.89
  - direccion privada: 10.240.1.172

API Server
  - direccion publica: 169.59.188.74
  - direccion privada: 10.241.64.97

Backend
  - direccion privada: 10.241.64.98


IMPORTANTE: 
-
Actualmente tenemos la aplicacion Busca Cliente, como esta indicada en el primer paso del Workshop de APIC. La aplicacion aun no esta integrada con APIC y buscamos que todos los pasos aqui detallados, sean independientes de los pasos 2 al 12 del Workshop.

Para poder avanzar, los tres servidores deben estar configurados tal como se detalla en el primer paso del Workshop.


Construir la Base de datos 
--


```
USE clientes_db;

CREATE TABLE historial_clientes (
  IdCliente INT,
  fecha DATE,
  accion VARCHAR(100)
);

INSERT INTO historial_clientes VALUES
(1, '2024-01-10', 'Actualizaci칩n de direcci칩n'),
(1, '2024-03-15', 'Cambio de nombre'),
(2, '2024-02-01', 'Registro nuevo');
```

Construir la API SOAP
--

En el servidor de APIs, crear el archivo /var/www/html/api/soap_historial.php con el siguiente codigo

```
<?php
// soap_historial.php

ini_set("soap.wsdl_cache_enabled", "0");
header("Content-Type: text/xml; charset=utf-8");

// Clase con la l칩gica del servicio
class HistorialClientesService {
    public function getHistorialPorId($idCliente) {
        $mysqli = new mysqli("10.241.64.98", "apiuser", "apipass", "clientes_db", 8080);
        $mysqli->set_charset("utf8mb4");

        if ($mysqli->connect_error) {
            throw new SoapFault("Server", "No se pudo conectar a la base de datos");
        }

        $stmt = $mysqli->prepare("SELECT fecha, accion FROM historial_clientes WHERE IdCliente = ?");
        $stmt->bind_param("i", $idCliente);
        $stmt->execute();
        $result = $stmt->get_result();

        $historial = [];
        while ($row = $result->fetch_assoc()) {
            $historial[] = $row;
        }

        $stmt->close();
        $mysqli->close();

        return $historial;
    }
}

// Opciones del servidor SOAP
$server = new SoapServer(null, [
    'uri' => "http://{$_SERVER['HTTP_HOST']}{$_SERVER['PHP_SELF']}"
]);

$server->setClass("HistorialClientesService");
$server->handle();
?>

```

Instalar SOAP en la VM

```
sudo dnf install -y php-soap
sudo systemctl restart httpd
```


Construimos el cliente que llama a la API SOAP en PHP
--

En el Frontend creamos un archivo /var/www/html/test_soap_client.php

```
<?php
$client = new SoapClient(null, [
    'location' => 'http://169.59.188.74:8080/api/soap_historial.php',
    'uri' => 'http://169.59.188.74:8080/api/soap_historial.php',
    'trace' => 1
]);

try {
    $id = 1;
    $result = $client->getHistorialPorId($id);
    echo "<h2>Historial para cliente #$id</h2><ul>";
    foreach ($result as $item) {
        echo "<li>{$item['fecha']}: {$item['accion']}</li>";
    }
    echo "</ul>";
} catch (SoapFault $e) {
    echo "Error: " . $e->getMessage();
}
?>


```

Para poder ejecutar, hay que instalar PHP (si aun no lo hemos hecho)

```
dnf install -y php php-soap
systemctl restart httpd

```

Testear la API SOAP desde el navegador
--

```
http://52.116.143.89:8080/test_soap_client.php
```

Deberiamos tener un resultado como el que sigue


<img width="1133" height="227" alt="image" src="https://github.com/user-attachments/assets/9e87ed66-be1c-40f5-986e-7f15eb1ee21d" />


Crear archivo WSDL
=

El proximo paso es crear un archivo WSDL, que es usado para describir la API SOAP

Ese archivo debemos colocarlo en /var/www/html/api/soap_historial.wsdl donde esta la API.

```
<?xml version="1.0" encoding="UTF-8"?>
<definitions name="HistorialClientesService"
             targetNamespace="http://example.com/historial"
             xmlns:tns="http://example.com/historial"
             xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema"
             xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"
             xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
             xmlns="http://schemas.xmlsoap.org/wsdl/">

  <types>
    <xsd:schema targetNamespace="http://example.com/historial">
      <xsd:complexType name="HistorialItem">
        <xsd:sequence>
          <xsd:element name="fecha" type="xsd:string"/>
          <xsd:element name="accion" type="xsd:string"/>
        </xsd:sequence>
      </xsd:complexType>

      <xsd:complexType name="HistorialArray">
        <xsd:sequence>
          <xsd:element name="item" type="tns:HistorialItem" minOccurs="0" maxOccurs="unbounded"/>
        </xsd:sequence>
      </xsd:complexType>
    </xsd:schema>
  </types>

  <message name="getHistorialPorIdRequest">
    <part name="idCliente" type="xsd:int"/>
  </message>

  <message name="getHistorialPorIdResponse">
    <part name="historial" type="tns:HistorialArray"/>
  </message>

  <portType name="HistorialClientesPortType">
    <operation name="getHistorialPorId">
      <input message="tns:getHistorialPorIdRequest"/>
      <output message="tns:getHistorialPorIdResponse"/>
    </operation>
  </portType>

  <binding name="HistorialClientesBinding" type="tns:HistorialClientesPortType">
    <soap:binding style="rpc" transport="http://schemas.xmlsoap.org/soap/http"/>
    <operation name="getHistorialPorId">
      <soap:operation soapAction="getHistorialPorId"/>
      <input>
        <soap:body use="encoded" namespace="http://example.com/historial" encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"/>
      </input>
      <output>
        <soap:body use="encoded" namespace="http://example.com/historial" encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"/>
      </output>
    </operation>
  </binding>

  <service name="HistorialClientesService">
    <documentation>Servicio para obtener historial de clientes</documentation>
    <port name="HistorialClientesPort" binding="tns:HistorialClientesBinding">
      <soap:address location="http://169.59.188.74:8080/api/soap_historial.php"/>
    </port>
  </service>
</definitions>

```

Debemos modificar el API, para que use el WSDL

```
<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

class HistorialClientesService {
    public function getHistorialPorId($idCliente) {
        $mysqli = new mysqli("10.241.64.98", "apiuser", "apipass", "clientes_db", 8080);
        $mysqli->set_charset("utf8mb4");

        if ($mysqli->connect_error) {
            throw new SoapFault("Server", "No se pudo conectar a la base de datos: " . $mysqli->connect_error);
        }

        $stmt = $mysqli->prepare("SELECT fecha, accion FROM historial_clientes WHERE IdCliente = ?");
        if (!$stmt) {
            throw new SoapFault("Server", "Error preparando la consulta: " . $mysqli->error);
        }
        $stmt->bind_param("i", $idCliente);
        $stmt->execute();
        $result = $stmt->get_result();

        $historial = [];
        while ($row = $result->fetch_assoc()) {
            $historial[] = $row;
        }

        $stmt->close();
        $mysqli->close();

        return $historial;
    }
}

$wsdl = "http://169.59.188.74:8080/api/soap_historial.wsdl";
$server = new SoapServer($wsdl);

$server->setClass("HistorialClientesService");

try {
    $server->handle();
} catch (SoapFault $fault) {
    error_log("SOAP Fault: " . $fault->getMessage());
    throw $fault;
}

```

Verificamos que el WSDL es accesible

```
curl http://169.59.188.74:8080/api/soap_historial.wsdl
```

