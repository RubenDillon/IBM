# Asegurando los Secretos

Durante el desarrollo del workshop hemos visto como crear Client Id y Client Secret, hemos visto como conectarnos por la API a la base de datos... pero tambien, hemos visto como dejar esas credenciales en archivos php o html. 

Claramente no es una buena practica, dejarlos con tan simple acceso. Por eso, vamos a hacer uso de Hashicorp Vault que es una boveda para guardar secretos.

En Vault vamos a generar estos secretos y vamos a consultarlos, cuando se requiera.

Para poder agregar este contenido, vamos a estar agregando una maquina virtual para poder instalar Hashicorp Vault.

---

Desplegar Vault
=


```bash
#!/bin/bash
# Instala y configura HashiCorp Vault (Open Source) en RHEL 9 (VM4)

# Instalar dependencias
sudo dnf install -y unzip curl jq

# crear el repo
sudo tee /etc/yum.repos.d/hashicorp.repo <<EOF
[hashicorp]
name=HashiCorp Stable - RHEL 9
baseurl=https://rpm.releases.hashicorp.com/RHEL/9/x86_64/stable
enabled=1
gpgcheck=1
gpgkey=https://rpm.releases.hashicorp.com/gpg
EOF

# instalar Vault
sudo dnf clean all
sudo dnf install -y vault

echo $PATH
export PATH=$PATH:/usr/bin

# Crear usuario y carpeta de datos
sudo useradd --system --home /etc/vault.d --shell /bin/false vault
sudo mkdir -p /etc/vault.d /var/lib/vault
sudo chown -R vault:vault /etc/vault.d /var/lib/vault

# Crear archivo de configuraciÃ³n
cat <<EOF | sudo tee /etc/vault.d/vault.hcl
listener "tcp" {
  address     = "0.0.0.0:8080"
  tls_disable = 1
}

storage "file" {
  path = "/var/lib/vault"
}

ui = true
disable_mlock = true
EOF

# Crear servicio systemd
cat <<EOF | sudo tee /etc/systemd/system/vault.service
[Unit]
Description=Vault Service
After=network.target

[Service]
User=vault
Group=vault
ExecStart=/usr/local/bin/vault server -config=/etc/vault.d/vault.hcl
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

# Habilitar y arrancar
sudo systemctl daemon-reexec
sudo systemctl enable vault
sudo systemctl start vault


```

---

Inicializar Vault
=

1) Inicializa Vault

```bash
echo $PATH
export PATH=$PATH:/usr/local/bin
export VAULT_ADDR="http://169.63.187.221:8080"
vault status
vault operator init -key-shares=1 -key-threshold=1 > /root/vault_init.txt
```
2) Guardamos unseal key y el root token

```bash
VAULT_UNSEAL_KEY=$(grep 'Unseal Key 1:' /root/vault_init.txt | awk '{print $NF}')
VAULT_TOKEN=$(grep 'Initial Root Token:' /root/vault_init.txt | awk '{print $NF}')

echo $VAULT_UNSEAL_KEY
echo $VAULT_TOKEN
```
4) desbloqueamos Vault

```bash
vault operator unseal $(grep 'Unseal Key 1:' /root/vault_init.txt | awk '{print $NF}')
```
o usamos

```bash
vault operator unseal $VAULT_UNSEAL_KEY
```

5) Nos logueamos con el usuario root

```bash
vault login $VAULT_TOKEN
```

4) Creamos los dos secretos

```bash
vault kv put workshop/db usuario=apiuser password=apipass
vault kv put workshop/ibmapi client_id=a3abc43608c0de849addfdc338589e4c client_secret=98ec18754fc0742e90a2f03176aa75e2
```

5) 



